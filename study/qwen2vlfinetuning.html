<!doctype html>
<html lang="ko-KR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.23" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <meta name="keywords" content="ê³µë¶€ê¸°ë¡, í•™ìŠµì¼ê¸°, ì§€ì‹ì €ì¥ì†Œ, ê³µë¶€ë¡œê·¸, í•™ìŠµê´€ë¦¬, ê³µë¶€ë…¸íŠ¸, ì§€ì‹ì •ë¦¬, ê³µë¶€ë°©ë²•, í•™ìŠµì €ì¥, ê¸°ì–µë³´ì¡°"><meta property="og:title" content="ğŸ“š ë‘ë‡Œ ì €ì¥ì†Œ - ì¬ë¯¸ìˆëŠ” ê³µë¶€ ê¸°ë¡ ë†€ì´í„°"><meta property="og:description" content="ê¹Œë¨¹ì§€ ë§ê³  ì¬ë°Œê²Œ ì €ì¥í•˜ì! ğŸ¯ ê³µë¶€í•œ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ëŠ” ì¦ê±°ìš´ ì§€ì‹ ì €ì¥ì†Œ"><meta property="og:image" content="https://doc.empasy.com/images/favicon.png"><meta property="og:url" content="https://doc.empasy.com/study/"><link rel="icon" href="/images/favicon.ico"><meta name="author" content="ì— íŒŒì‹œ"><meta name="theme-color" content="#3eaf7c"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="naver-site-verification" content="3102a764f7ad54fe27ab3083cd0a7b0f647be4c7"><link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png"><link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#3eaf7c"><meta name="msapplication-TileImage" content="/images/icons/mstile-150x150.png"><meta name="msapplication-TileColor" content="#3eaf7c"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet"><script src="https://www.googletagmanager.com/gtag/js?id=G-6BNPM5TX7C" async></script><script> window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6BNPM5TX7C'); </script><meta name="application-name" content="Empasy"><meta name="mobile-web-app-capable" content="yes"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><script>((w,d,s,l,i)=>{w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KPMTVVXN');</script><title>Qwen2 VL Fine-Tuning | ì‚´ì•„ ìˆëŠ” ì†Œí”„íŠ¸ì›¨ì–´ëŠ” ì— íŒŒì‹œê°€ ë§Œë“­ë‹ˆë‹¤</title><meta name="description" content="Qwen2 VL ëª¨ë¸ FIne-Tuning">
    <link rel="preload" href="/assets/style-BrGqinhp.css" as="style"><link rel="stylesheet" href="/assets/style-BrGqinhp.css">
    <link rel="modulepreload" href="/assets/app-DMFZZpaT.js"><link rel="modulepreload" href="/assets/qwen2vlfinetuning.html-BsMiaEKm.js">
    
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name vp-hide-mobile" aria-hidden="true">ì‚´ì•„ ìˆëŠ” ì†Œí”„íŠ¸ì›¨ì–´ëŠ” ì— íŒŒì‹œê°€ ë§Œë“­ë‹ˆë‹¤</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="í™ˆ"><!--[--><!--[--><!--]--><!--]-->í™ˆ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/syncboot/" aria-label="SyncBoot"><!--[--><!--[--><!--]--><!--]-->SyncBoot<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/syncadmin/" aria-label="SyncAdmin"><!--[--><!--[--><!--]--><!--]-->SyncAdmin<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/synccms/" aria-label="SyncCms"><!--[--><!--[--><!--]--><!--]-->SyncCms<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/syncapim/" aria-label="SyncApim"><!--[--><!--[--><!--]--><!--]-->SyncApim<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/synceta/" aria-label="SyncETA"><!--[--><!--[--><!--]--><!--]-->SyncETA<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/agile/" aria-label="ì• ìì¼"><!--[--><!--[--><!--]--><!--]-->ì• ìì¼<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://www.empasy.com/assets/pdf/empasy_guide_v1.8.pdf" aria-label="PDF ë‹¤ìš´ë¡œë“œ" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->PDF ë‹¤ìš´ë¡œë“œ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://www.empasy.com" aria-label="ì— íŒŒì‹œ" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->ì— íŒŒì‹œ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/DramaticCollaboration/" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search for documents" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="í™ˆ"><!--[--><!--[--><!--]--><!--]-->í™ˆ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/syncboot/" aria-label="SyncBoot"><!--[--><!--[--><!--]--><!--]-->SyncBoot<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/syncadmin/" aria-label="SyncAdmin"><!--[--><!--[--><!--]--><!--]-->SyncAdmin<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/synccms/" aria-label="SyncCms"><!--[--><!--[--><!--]--><!--]-->SyncCms<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/syncapim/" aria-label="SyncApim"><!--[--><!--[--><!--]--><!--]-->SyncApim<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/synceta/" aria-label="SyncETA"><!--[--><!--[--><!--]--><!--]-->SyncETA<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/agile/" aria-label="ì• ìì¼"><!--[--><!--[--><!--]--><!--]-->ì• ìì¼<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://www.empasy.com/assets/pdf/empasy_guide_v1.8.pdf" aria-label="PDF ë‹¤ìš´ë¡œë“œ" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->PDF ë‹¤ìš´ë¡œë“œ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://www.empasy.com" aria-label="ì— íŒŒì‹œ" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->ì— íŒŒì‹œ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/DramaticCollaboration/" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active collapsible">ê³µë¶€ë°© <span class="down arrow"></span></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/study/rag.html" aria-label="RAG"><!--[--><!--[--><!--]--><!--]-->RAG<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/study/qwen2vlfinetuning.html" aria-label="Qwen2 VL Fine-Tuning"><!--[--><!--[--><!--]--><!--]-->Qwen2 VL Fine-Tuning<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="qwen2-vl-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„€á…¡á„‹á…µá„ƒá…³-by-llm" tabindex="-1"><a class="header-anchor" href="#qwen2-vl-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„€á…¡á„‹á…µá„ƒá…³-by-llm"><span>Qwen2-VL íŒŒì¸íŠœë‹ ê°€ì´ë“œ by LLM</span></a></h1><h2 id="ğŸ¯-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„Œá…¥á†«-á„Œá…®á†«á„‡á…µá„‰á…¡á„’á…¡á†¼" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„Œá…¥á†«-á„Œá…®á†«á„‡á…µá„‰á…¡á„’á…¡á†¼"><span>ğŸ¯ íŒŒì¸íŠœë‹ ì „ ì¤€ë¹„ì‚¬í•­</span></a></h2><h3 id="_1-á„’á…ªá†«á„€á…§á†¼-á„‰á…¥á†¯á„Œá…¥á†¼" tabindex="-1"><a class="header-anchor" href="#_1-á„’á…ªá†«á„€á…§á†¼-á„‰á…¥á†¯á„Œá…¥á†¼"><span>1. <strong>í™˜ê²½ ì„¤ì •</strong></span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment"># í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜</span></span>
<span class="line">pip <span class="token function">install</span> transformers<span class="token operator">&gt;=</span><span class="token number">4.37</span>.0</span>
<span class="line">pip <span class="token function">install</span> accelerate</span>
<span class="line">pip <span class="token function">install</span> datasets</span>
<span class="line">pip <span class="token function">install</span> peft</span>
<span class="line">pip <span class="token function">install</span> torch<span class="token operator">&gt;=</span><span class="token number">2.0</span>.0</span>
<span class="line">pip <span class="token function">install</span> torchvision</span>
<span class="line">pip <span class="token function">install</span> pillow</span>
<span class="line">pip <span class="token function">install</span> einops</span>
<span class="line">pip <span class="token function">install</span> timm</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Qwen2-VL ì „ìš© íŒ¨í‚¤ì§€</span></span>
<span class="line">pip <span class="token function">install</span> git+https://github.com/QwenLM/Qwen2-VL.git</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-á„’á…¡á„ƒá…³á„‹á…°á„‹á…¥-á„‹á…­á„€á…®á„‰á…¡á„’á…¡á†¼" tabindex="-1"><a class="header-anchor" href="#_2-á„’á…¡á„ƒá…³á„‹á…°á„‹á…¥-á„‹á…­á„€á…®á„‰á…¡á„’á…¡á†¼"><span>2. <strong>í•˜ë“œì›¨ì–´ ìš”êµ¬ì‚¬í•­</strong></span></a></h3><ul><li><strong>GPU ë©”ëª¨ë¦¬</strong>: <ul><li>Full Fine-tuning: 80GB+ (A100 80GB)</li><li>LoRA Fine-tuning: 24GB+ (RTX 4090)</li><li>QLoRA: 16GB+ (V100 16GB)</li></ul></li></ul><h2 id="ğŸ“Š-á„ƒá…¦á„‹á…µá„á…¥á„‰á…¦á†º-á„’á…§á†¼á„‰á…µá†¨" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-á„ƒá…¦á„‹á…µá„á…¥á„‰á…¦á†º-á„’á…§á†¼á„‰á…µá†¨"><span>ğŸ“Š ë°ì´í„°ì…‹ í˜•ì‹</span></a></h2><h3 id="_1-á„‘á…­á„Œá…®á†«-á„ƒá…¦á„‹á…µá„á…¥-á„’á…§á†¼á„‰á…µá†¨" tabindex="-1"><a class="header-anchor" href="#_1-á„‘á…­á„Œá…®á†«-á„ƒá…¦á„‹á…µá„á…¥-á„’á…§á†¼á„‰á…µá†¨"><span>1. <strong>í‘œì¤€ ë°ì´í„° í˜•ì‹</strong></span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;conversations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;image&gt;\nì´ ì´ë¯¸ì§€ì—ì„œ ë¬´ì—‡ì´ ë³´ì´ë‚˜ìš”?&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ì´ ì´ë¯¸ì§€ì—ëŠ” ë¹¨ê°„ìƒ‰ ìŠ¤í¬ì¸ ì¹´ê°€ ë„ë¡œ ìœ„ì— ì£¼ì°¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;base64_encoded_image_or_image_path&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-á„ƒá…¡á„Œá…®á†¼-á„á…¥á†«-á„ƒá…¢á„’á…ª-á„’á…§á†¼á„‰á…µá†¨" tabindex="-1"><a class="header-anchor" href="#_2-á„ƒá…¡á„Œá…®á†¼-á„á…¥á†«-á„ƒá…¢á„’á…ª-á„’á…§á†¼á„‰á…µá†¨"><span>2. <strong>ë‹¤ì¤‘ í„´ ëŒ€í™” í˜•ì‹</strong></span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;conversations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;image&gt;\nì´ ì‚¬ì§„ì˜ ë°°ê²½ì€ ì–´ë””ì¸ê°€ìš”?&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ë„ì‹œì˜ ê±°ë¦¬ì…ë‹ˆë‹¤.&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ì°¨ëŸ‰ì˜ ìƒ‰ìƒì€ ë¬´ì—‡ì¸ê°€ìš”?&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ë¹¨ê°„ìƒ‰ì…ë‹ˆë‹¤.&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;base64_encoded_image&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„‡á…¡á†¼á„‡á…¥á†¸" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„‡á…¡á†¼á„‡á…¥á†¸"><span>ğŸ”§ íŒŒì¸íŠœë‹ ë°©ë²•</span></a></h2><h3 id="_1-full-fine-tuning" tabindex="-1"><a class="header-anchor" href="#_1-full-fine-tuning"><span>1. <strong>Full Fine-tuning</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># full_finetune.py</span></span>
<span class="line"><span class="token keyword">import</span> torch</span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    Qwen2VLForConditionalGeneration<span class="token punctuation">,</span></span>
<span class="line">    Qwen2VLProcessor<span class="token punctuation">,</span></span>
<span class="line">    TrainingArguments<span class="token punctuation">,</span></span>
<span class="line">    Trainer</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">from</span> datasets <span class="token keyword">import</span> Dataset</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ëª¨ë¸ ë¡œë“œ</span></span>
<span class="line">model <span class="token operator">=</span> Qwen2VLForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span></span>
<span class="line">    device_map<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">processor <span class="token operator">=</span> Qwen2VLProcessor<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ë°ì´í„°ì…‹ ì¤€ë¹„</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">load_dataset</span><span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">        data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">process_example</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># ì´ë¯¸ì§€ ì²˜ë¦¬</span></span>
<span class="line">        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>example<span class="token punctuation">[</span><span class="token string">&#39;image_path&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">&#39;RGB&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># ëŒ€í™” ì²˜ë¦¬</span></span>
<span class="line">        conversations <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#39;conversations&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        text <span class="token operator">=</span> processor<span class="token punctuation">.</span>apply_chat_template<span class="token punctuation">(</span>conversations<span class="token punctuation">,</span> add_generation_prompt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;pixel_values&#39;</span><span class="token punctuation">:</span> processor<span class="token punctuation">.</span>image_processor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">&quot;pt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pixel_values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">:</span> processor<span class="token punctuation">.</span>tokenizer<span class="token punctuation">(</span>text<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">&quot;pt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_ids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;labels&#39;</span><span class="token punctuation">:</span> processor<span class="token punctuation">.</span>tokenizer<span class="token punctuation">(</span>text<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">&quot;pt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_ids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> Dataset<span class="token punctuation">.</span>from_list<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>process_example<span class="token punctuation">,</span> batched<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">train_dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">&quot;train_data.json&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Training Arguments</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    output_dir<span class="token operator">=</span><span class="token string">&quot;./qwen2-vl-finetuned&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    per_device_train_batch_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">    learning_rate<span class="token operator">=</span><span class="token number">2e-5</span><span class="token punctuation">,</span></span>
<span class="line">    num_train_epochs<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    logging_steps<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">    save_steps<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span></span>
<span class="line">    eval_steps<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span></span>
<span class="line">    warmup_steps<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">    weight_decay<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span></span>
<span class="line">    gradient_checkpointing<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    remove_unused_columns<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Trainer ì„¤ì •</span></span>
<span class="line">trainer <span class="token operator">=</span> Trainer<span class="token punctuation">(</span></span>
<span class="line">    model<span class="token operator">=</span>model<span class="token punctuation">,</span></span>
<span class="line">    args<span class="token operator">=</span>training_args<span class="token punctuation">,</span></span>
<span class="line">    train_dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span></span>
<span class="line">    data_collator<span class="token operator">=</span><span class="token keyword">lambda</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&#39;pixel_values&#39;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">&#39;pixel_values&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>pad_sequence<span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            padding_value<span class="token operator">=</span>processor<span class="token punctuation">.</span>tokenizer<span class="token punctuation">.</span>pad_token_id</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;labels&#39;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>pad_sequence<span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">&#39;labels&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            padding_value<span class="token operator">=</span><span class="token operator">-</span><span class="token number">100</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># í•™ìŠµ ì‹œì‘</span></span>
<span class="line">trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">trainer<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-lora-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼" tabindex="-1"><a class="header-anchor" href="#_2-lora-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼"><span>2. <strong>LoRA íŒŒì¸íŠœë‹</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># lora_finetune.py</span></span>
<span class="line"><span class="token keyword">from</span> peft <span class="token keyword">import</span> LoraConfig<span class="token punctuation">,</span> get_peft_model</span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> Qwen2VLForConditionalGeneration</span>
<span class="line"></span>
<span class="line"><span class="token comment"># LoRA ì„¤ì •</span></span>
<span class="line">lora_config <span class="token operator">=</span> LoraConfig<span class="token punctuation">(</span></span>
<span class="line">    r<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></span>
<span class="line">    lora_alpha<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span></span>
<span class="line">    target_modules<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;q_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;k_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;o_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gate_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;up_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;down_proj&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    lora_dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span></span>
<span class="line">    bias<span class="token operator">=</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    task_type<span class="token operator">=</span><span class="token string">&quot;CAUSAL_LM&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ëª¨ë¸ì— LoRA ì ìš©</span></span>
<span class="line">model <span class="token operator">=</span> Qwen2VLForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span></span>
<span class="line">    device_map<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> get_peft_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span> lora_config<span class="token punctuation">)</span></span>
<span class="line">model<span class="token punctuation">.</span>print_trainable_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># í•™ìŠµë¥ ì„ ë” ë†’ê²Œ ì„¤ì •</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    output_dir<span class="token operator">=</span><span class="token string">&quot;./qwen2-vl-lora&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    per_device_train_batch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>  <span class="token comment"># LoRAëŠ” ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ì ìŒ</span></span>
<span class="line">    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    learning_rate<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">,</span>  <span class="token comment"># ë” ë†’ì€ í•™ìŠµë¥ </span></span>
<span class="line">    num_train_epochs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment"># ... ë‚˜ë¨¸ì§€ ì„¤ì •ì€ ë™ì¼</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-qlora-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-4bit-á„‹á…£á†¼á„Œá…¡á„’á…ª" tabindex="-1"><a class="header-anchor" href="#_3-qlora-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-4bit-á„‹á…£á†¼á„Œá…¡á„’á…ª"><span>3. <strong>QLoRA íŒŒì¸íŠœë‹ (4bit ì–‘ìí™”)</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># qlora_finetune.py</span></span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> BitsAndBytesConfig</span>
<span class="line"><span class="token keyword">from</span> peft <span class="token keyword">import</span> prepare_model_for_kbit_training</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4bit ì–‘ìí™” ì„¤ì •</span></span>
<span class="line">quantization_config <span class="token operator">=</span> BitsAndBytesConfig<span class="token punctuation">(</span></span>
<span class="line">    load_in_4bit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    bnb_4bit_use_double_quant<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    bnb_4bit_quant_type<span class="token operator">=</span><span class="token string">&quot;nf4&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    bnb_4bit_compute_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ì–‘ìí™”ëœ ëª¨ë¸ ë¡œë“œ</span></span>
<span class="line">model <span class="token operator">=</span> Qwen2VLForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    quantization_config<span class="token operator">=</span>quantization_config<span class="token punctuation">,</span></span>
<span class="line">    device_map<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># QLoRA ì¤€ë¹„</span></span>
<span class="line">model <span class="token operator">=</span> prepare_model_for_kbit_training<span class="token punctuation">(</span>model<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># LoRA ì„¤ì • (QLoRA)</span></span>
<span class="line">lora_config <span class="token operator">=</span> LoraConfig<span class="token punctuation">(</span></span>
<span class="line">    r<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>  <span class="token comment"># ë” ì‘ì€ rank</span></span>
<span class="line">    lora_alpha<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></span>
<span class="line">    target_modules<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;q_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v_proj&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># ì£¼ìš” ëª¨ë“ˆë§Œ ëŒ€ìƒ</span></span>
<span class="line">    lora_dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span></span>
<span class="line">    bias<span class="token operator">=</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    task_type<span class="token operator">=</span><span class="token string">&quot;CAUSAL_LM&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> get_peft_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span> lora_config<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“-á„ƒá…¦á„‹á…µá„á…¥-á„Œá…¥á†«á„á…¥á„…á…µ-á„‹á…²á„á…µá†¯á„…á…µá„á…µ" tabindex="-1"><a class="header-anchor" href="#ğŸ“-á„ƒá…¦á„‹á…µá„á…¥-á„Œá…¥á†«á„á…¥á„…á…µ-á„‹á…²á„á…µá†¯á„…á…µá„á…µ"><span>ğŸ“ ë°ì´í„° ì „ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹°</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># data_utils.py</span></span>
<span class="line"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image</span>
<span class="line"><span class="token keyword">import</span> base64</span>
<span class="line"><span class="token keyword">import</span> io</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">image_to_base64</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> image_file<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>image_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">base64_to_image</span><span class="token punctuation">(</span>base64_str<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;base64ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜&quot;&quot;&quot;</span></span>
<span class="line">    image_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>base64_str<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">create_conversation_dataset</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> questions<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;ë°ì´í„°ì…‹ ìƒì„± ë„ìš°ë¯¸&quot;&quot;&quot;</span></span>
<span class="line">    dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">for</span> img_path<span class="token punctuation">,</span> question<span class="token punctuation">,</span> answer <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> questions<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;conversations&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;&lt;image&gt;\n</span><span class="token interpolation"><span class="token punctuation">{</span>question<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> answer</span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;image&quot;</span><span class="token punctuation">:</span> image_to_base64<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> dataset</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">save_dataset</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> output_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;ë°ì´í„°ì…‹ ì €ì¥&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> <span class="token string">&#39;w&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸš€-á„’á…¡á†¨á„‰á…³á†¸-á„‰á…³á„á…³á„…á…µá†¸á„á…³-á„‹á…¨á„Œá…¦" tabindex="-1"><a class="header-anchor" href="#ğŸš€-á„’á…¡á†¨á„‰á…³á†¸-á„‰á…³á„á…³á„…á…µá†¸á„á…³-á„‹á…¨á„Œá…¦"><span>ğŸš€ í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì œ</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># train_qwen2_vl.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># í™˜ê²½ ë³€ìˆ˜ ì„¤ì •</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">MODEL_NAME</span><span class="token operator">=</span><span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">DATA_PATH</span><span class="token operator">=</span><span class="token string">&quot;train_data.json&quot;</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">OUTPUT_DIR</span><span class="token operator">=</span><span class="token string">&quot;./qwen2-vl-finetuned&quot;</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">BATCH_SIZE</span><span class="token operator">=</span><span class="token number">2</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">LEARNING_RATE</span><span class="token operator">=</span>2e-5</span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">EPOCHS</span><span class="token operator">=</span><span class="token number">3</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># í•™ìŠµ ì‹¤í–‰</span></span>
<span class="line">python <span class="token parameter variable">-m</span> torch.distributed.launch <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--nproc_per_node</span><span class="token operator">=</span><span class="token number">4</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--master_port</span><span class="token operator">=</span><span class="token number">29500</span> <span class="token punctuation">\</span></span>
<span class="line">    train_qwen2_vl.py <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--model_name</span> <span class="token variable">$MODEL_NAME</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--data_path</span> <span class="token variable">$DATA_PATH</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--output_dir</span> <span class="token variable">$OUTPUT_DIR</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--per_device_train_batch_size</span> <span class="token variable">$BATCH_SIZE</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--learning_rate</span> <span class="token variable">$LEARNING_RATE</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--num_train_epochs</span> <span class="token variable">$EPOCHS</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--fp16</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--gradient_checkpointing</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--logging_steps</span> <span class="token number">10</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--save_steps</span> <span class="token number">500</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”-á„‘á…§á†¼á„€á…¡-á„†á…µá†¾-á„á…®á„…á…©á†«" tabindex="-1"><a class="header-anchor" href="#ğŸ”-á„‘á…§á†¼á„€á…¡-á„†á…µá†¾-á„á…®á„…á…©á†«"><span>ğŸ” í‰ê°€ ë° ì¶”ë¡ </span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># evaluate.py</span></span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> pipeline</span>
<span class="line"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image</span>
<span class="line"></span>
<span class="line"><span class="token comment"># íŒŒì¸íŠœë‹ëœ ëª¨ë¸ ë¡œë“œ</span></span>
<span class="line">model_path <span class="token operator">=</span> <span class="token string">&quot;./qwen2-vl-finetuned&quot;</span></span>
<span class="line">vl_pipeline <span class="token operator">=</span> pipeline<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;visual-question-answering&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    model<span class="token operator">=</span>model_path<span class="token punctuation">,</span></span>
<span class="line">    device<span class="token operator">=</span><span class="token string">&quot;cuda:0&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€</span></span>
<span class="line">image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;test_image.jpg&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ì¶”ë¡ </span></span>
<span class="line">question <span class="token operator">=</span> <span class="token string">&quot;ì´ ì´ë¯¸ì§€ì—ì„œ ë¬´ì—‡ì´ ë³´ì´ë‚˜ìš”?&quot;</span></span>
<span class="line">result <span class="token operator">=</span> vl_pipeline<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">,</span> question<span class="token operator">=</span>question<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Question: </span><span class="token interpolation"><span class="token punctuation">{</span>question<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Answer: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">&#39;answer&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Confidence: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">&#39;score&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="âš¡-á„á…¬á„Œá…¥á†¨á„’á…ª-á„á…µá†¸" tabindex="-1"><a class="header-anchor" href="#âš¡-á„á…¬á„Œá…¥á†¨á„’á…ª-á„á…µá†¸"><span>âš¡ ìµœì í™” íŒ</span></a></h2><h3 id="_1-á„†á…¦á„†á…©á„…á…µ-á„á…¬á„Œá…¥á†¨á„’á…ª" tabindex="-1"><a class="header-anchor" href="#_1-á„†á…¦á„†á…©á„…á…µ-á„á…¬á„Œá…¥á†¨á„’á…ª"><span>1. <strong>ë©”ëª¨ë¦¬ ìµœì í™”</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># ê·¸ë˜ë””ì–¸íŠ¸ ì²´í¬í¬ì¸íŒ…</span></span>
<span class="line">model<span class="token punctuation">.</span>gradient_checkpointing_enable<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì¡°ì •</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    per_device_train_batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>  <span class="token comment"># íš¨ê³¼ì  ë°°ì¹˜ í¬ê¸°: 8</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># mixed precision training</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># ë˜ëŠ” bf16=True</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-á„’á…¡á†¨á„‰á…³á†¸á„…á…²á†¯-á„‰á…³á„á…¦á„Œá…®á†¯á„…á…µá†¼" tabindex="-1"><a class="header-anchor" href="#_2-á„’á…¡á†¨á„‰á…³á†¸á„…á…²á†¯-á„‰á…³á„á…¦á„Œá…®á†¯á„…á…µá†¼"><span>2. <strong>í•™ìŠµë¥  ìŠ¤ì¼€ì¤„ë§</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> get_cosine_schedule_with_warmup</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ì›œì—… ìŠ¤ì¼€ì¤„ëŸ¬</span></span>
<span class="line">num_training_steps <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_dataloader<span class="token punctuation">)</span> <span class="token operator">*</span> num_epochs</span>
<span class="line">num_warmup_steps <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">*</span> num_training_steps<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">scheduler <span class="token operator">=</span> get_cosine_schedule_with_warmup<span class="token punctuation">(</span></span>
<span class="line">    optimizer<span class="token punctuation">,</span></span>
<span class="line">    num_warmup_steps<span class="token operator">=</span>num_warmup_steps<span class="token punctuation">,</span></span>
<span class="line">    num_training_steps<span class="token operator">=</span>num_training_steps</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¯-á„á…³á†¨á„Œá…¥á†¼-á„á…¢á„‰á…³á„á…³-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„‹á…¨á„Œá…¦" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-á„á…³á†¨á„Œá…¥á†¼-á„á…¢á„‰á…³á„á…³-á„‘á…¡á„‹á…µá†«á„á…²á„‚á…µá†¼-á„‹á…¨á„Œá…¦"><span>ğŸ¯ íŠ¹ì • íƒœìŠ¤í¬ íŒŒì¸íŠœë‹ ì˜ˆì œ</span></a></h2><h3 id="_1-á„‹á…µá„†á…µá„Œá…µ-á„á…¢á†¸á„‰á…§á„‚á…µá†¼" tabindex="-1"><a class="header-anchor" href="#_1-á„‹á…µá„†á…µá„Œá…µ-á„á…¢á†¸á„‰á…§á„‚á…µá†¼"><span>1. <strong>ì´ë¯¸ì§€ ìº¡ì…”ë‹</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">prepare_captioning_data</span><span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> captions_file<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;ì´ë¯¸ì§€ ìº¡ì…”ë‹ ë°ì´í„° ì¤€ë¹„&quot;&quot;&quot;</span></span>
<span class="line">    dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>captions_file<span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span></span>
<span class="line">            img_name<span class="token punctuation">,</span> caption <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;\t&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;conversations&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                    <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;&lt;image&gt;\nì´ ì´ë¯¸ì§€ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”.&quot;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> caption</span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;image&quot;</span><span class="token punctuation">:</span> image_to_base64<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>image_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>img_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> dataset</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-vqa-visual-question-answering" tabindex="-1"><a class="header-anchor" href="#_2-vqa-visual-question-answering"><span>2. <strong>VQA (Visual Question Answering)</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">prepare_vqa_data</span><span class="token punctuation">(</span>questions_file<span class="token punctuation">,</span> annotations_file<span class="token punctuation">,</span> image_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;VQA ë°ì´í„° ì¤€ë¹„&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token comment"># questions ë° annotations íŒŒì¼ ì²˜ë¦¬</span></span>
<span class="line">    <span class="token comment"># ...</span></span>
<span class="line">    <span class="token keyword">return</span> vqa_dataset</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-á„†á…©á„‚á…µá„á…¥á„…á…µá†¼-á„†á…µá†¾-á„…á…©á„€á…µá†¼" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-á„†á…©á„‚á…µá„á…¥á„…á…µá†¼-á„†á…µá†¾-á„…á…©á„€á…µá†¼"><span>ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># wandb ì—°ë™</span></span>
<span class="line"><span class="token keyword">import</span> wandb</span>
<span class="line"></span>
<span class="line">wandb<span class="token punctuation">.</span>init<span class="token punctuation">(</span>project<span class="token operator">=</span><span class="token string">&quot;qwen2-vl-finetuning&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    output_dir<span class="token operator">=</span><span class="token string">&quot;./output&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    report_to<span class="token operator">=</span><span class="token string">&quot;wandb&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># wandbì— ë¦¬í¬íŠ¸</span></span>
<span class="line">    logging_dir<span class="token operator">=</span><span class="token string">&quot;./logs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    logging_steps<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ› ï¸-á„†á…®á†«á„Œá…¦-á„’á…¢á„€á…§á†¯" tabindex="-1"><a class="header-anchor" href="#ğŸ› ï¸-á„†á…®á†«á„Œá…¦-á„’á…¢á„€á…§á†¯"><span>ğŸ› ï¸ ë¬¸ì œ í•´ê²°</span></a></h2><h3 id="common-issues" tabindex="-1"><a class="header-anchor" href="#common-issues"><span><strong>Common Issues:</strong></span></a></h3><ol><li><strong>CUDA Out of Memory</strong>: ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì¤„ì´ê¸°, ê·¸ë˜ë””ì–¸íŠ¸ accumulation ì‚¬ìš©</li><li><strong>NaN Loss</strong>: í•™ìŠµë¥  ë‚®ì¶”ê¸°, gradient clipping ì ìš©</li><li><strong>Slow Training</strong>: mixed precision ì‚¬ìš©, ë°ì´í„° ë¡œë”© ìµœì í™”</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># ê·¸ë˜ë””ì–¸íŠ¸ í´ë¦¬í•‘</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    max_grad_norm<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token comment"># ê·¸ë˜ë””ì–¸íŠ¸ í´ë¦¬í•‘</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">ìˆ˜ì •ì¼: </span><time class="meta-item-info" datetime="2025-09-02T09:39:06.000Z" data-allow-mismatch>25. 9. 2. ì˜¤ì „ 9:39</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">ì‘ì„±ì: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: poh@empasy.com">poh</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/study/rag.html" aria-label="RAG"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">RAG</span></div><!--]--></a><!----></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DMFZZpaT.js" defer></script>
  </body>
</html>
