import{_ as n,c as e,a,o as i}from"./app-CU20V-HQ.js";const l={};function d(r,s){return i(),e("div",null,s[0]||(s[0]=[a(`<h1 id="integrated-sub-library-and-sub-table" tabindex="-1"><a class="header-anchor" href="#integrated-sub-library-and-sub-table"><span>Integrated sub-library and sub-table</span></a></h1><blockquote><p>version: jeecgboot 3.4This<br> article aims to: Through the example of jeecg-system-start project integration of sub-library and sub-table, explain how to integrate sub-library and sub-table in the monolithic architecture modeShardingSphere<br> official document: <a href="https://shardingsphere.apache.org/document/current/cn/overview" target="_blank" rel="noopener noreferrer">https://shardingsphere.apache.org/document/current/cn/overview</a></p></blockquote><h2 id="prepare-the-environment" tabindex="-1"><a class="header-anchor" href="#prepare-the-environment"><span><strong>Prepare the environment</strong></span></a></h2><ol><li>Data table: <code>sys_log0（日志分表1）</code>, just <code>sys_log1（日志分表2）</code>copy the system <code>sys_log</code>table</li><li>Database: <code>jeecg-boot2</code>(just copy jeecg-boot, separate database and table for use)</li></ol><h3 id="introduce-dependencies-choose-one-of-the-following-two-dependencies" tabindex="-1"><a class="header-anchor" href="#introduce-dependencies-choose-one-of-the-following-two-dependencies"><span><strong>Introduce dependencies (choose one of the following two dependencies)</strong></span></a></h3><p>The following dependencies are introduced without test cases</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">&lt;dependency&gt;</span>
<span class="line">    &lt;groupId&gt;org.jeecgframework.boot&lt;/groupId&gt;</span>
<span class="line">    &lt;artifactId&gt;jeecg-boot-starter-shardingsphere&lt;/artifactId&gt;</span>
<span class="line">&lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>copy</p><p>The test cases include the following dependencies. The default integrated test cases of jeecg-cloud-test-shardingsphere are convenient for testing. This example scenario is used to store logs in separate tables when inserting logs. The table partitioning rule is to calculate the remainder according to the log type. The remainder of 0 is stored in <code>sys_log0</code>the table, and the remainder of 1 is stored in <code>sys_log1</code>the table.</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">&lt;dependency&gt;</span>
<span class="line">    &lt;groupId&gt;org.jeecgframework.boot&lt;/groupId&gt;</span>
<span class="line">    &lt;artifactId&gt;jeecg-cloud-test-shardingsphere&lt;/artifactId&gt;</span>
<span class="line">    &lt;version&gt;\${jeecgboot.version}&lt;/version&gt;</span>
<span class="line">&lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>copy</p><h3 id="writing-sharding-rules" tabindex="-1"><a class="header-anchor" href="#writing-sharding-rules"><span><strong>Writing Sharding Rules</strong></span></a></h3><p>Corresponding to algorithmClassName in the configuration file : org.jeecg.sharding.algorithm.StandardModTableShardAlgorithm</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">package org.jeecg.sharding.algorithm;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">import org.apache.shardingsphere.sharding.api.sharding.standard.PreciseShardingValue;</span>
<span class="line">import org.apache.shardingsphere.sharding.api.sharding.standard.RangeShardingValue;</span>
<span class="line">import org.apache.shardingsphere.sharding.api.sharding.standard.StandardShardingAlgorithm;</span>
<span class="line"></span>
<span class="line">import java.util.Collection;</span>
<span class="line">import java.util.Properties;</span>
<span class="line"></span>
<span class="line">/**</span>
<span class="line"> * 用于处理使用单一键</span>
<span class="line"> * 根据分片字段的值和sharding-count进行取模运算</span>
<span class="line"> * SQL 语句中有&gt;，&gt;=, &lt;=，&lt;，=，IN 和 BETWEEN AND 操作符，都可以应用此分片策略。</span>
<span class="line"> *</span>
<span class="line"> * @author zyf</span>
<span class="line"> */</span>
<span class="line">public class StandardModTableShardAlgorithm implements StandardShardingAlgorithm&lt;Integer&gt; {</span>
<span class="line">    private Properties props = new Properties();</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    /**</span>
<span class="line">     * 用于处理=和IN的分片</span>
<span class="line">     *</span>
<span class="line">     * @param collection           目标分片的集合(表名)</span>
<span class="line">     * @param preciseShardingValue 逻辑表相关信息</span>
<span class="line">     * @return</span>
<span class="line">     */</span>
<span class="line">    @Override</span>
<span class="line">    public String doSharding(Collection&lt;String&gt; collection, PreciseShardingValue&lt;Integer&gt; preciseShardingValue) {</span>
<span class="line"></span>
<span class="line">        for (String name : collection) {</span>
<span class="line">            Integer value = preciseShardingValue.getValue();</span>
<span class="line">            //根据值进行取模，得到一个目标值</span>
<span class="line">            if (name.indexOf(value % 2+&quot;&quot;) &gt; -1) {</span>
<span class="line">                return name;</span>
<span class="line">            }</span>
<span class="line">        }</span>
<span class="line">        throw new UnsupportedOperationException();</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    /**</span>
<span class="line">     * 用于处理BETWEEN AND分片，如果不配置RangeShardingAlgorithm，SQL中的BETWEEN AND将按照全库路由处理</span>
<span class="line">     *</span>
<span class="line">     * @param collection</span>
<span class="line">     * @param rangeShardingValue</span>
<span class="line">     * @return</span>
<span class="line">     */</span>
<span class="line">    @Override</span>
<span class="line">    public Collection&lt;String&gt; doSharding(Collection&lt;String&gt; collection, RangeShardingValue&lt;Integer&gt; rangeShardingValue) {</span>
<span class="line"></span>
<span class="line">        return collection;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    /**</span>
<span class="line">     * 初始化对象的时候调用的方法</span>
<span class="line">     */</span>
<span class="line">    @Override</span>
<span class="line">    public void init() {</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    /**</span>
<span class="line">     * 对应分片算法（sharding-algorithms）的类型</span>
<span class="line">     *</span>
<span class="line">     * @return</span>
<span class="line">     */</span>
<span class="line">    @Override</span>
<span class="line">    public String getType() {</span>
<span class="line">        return &quot;STANDARD_MOD&quot;;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    @Override</span>
<span class="line">    public Properties getProps() {</span>
<span class="line">        return this.props;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    /**</span>
<span class="line">     * 获取分片相关属性</span>
<span class="line">     *</span>
<span class="line">     * @param properties</span>
<span class="line">     */</span>
<span class="line">    @Override</span>
<span class="line">    public void setProps(Properties properties) {</span>
<span class="line">        this.props = properties;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>copy</p><h3 id="modify-the-configuration-file" tabindex="-1"><a class="header-anchor" href="#modify-the-configuration-file"><span><strong>Modify the configuration file</strong></span></a></h3><h2 id="single-database-table-configuration" tabindex="-1"><a class="header-anchor" href="#single-database-table-configuration"><span><strong>Single database table configuration</strong></span></a></h2><ol><li>In <code>application-dev.yaml</code>the configuration file, add the following configuration</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">spring:</span>
<span class="line">  shardingsphere:</span>
<span class="line">    datasource:</span>
<span class="line">      names: ds0</span>
<span class="line">      ds0:</span>
<span class="line">        driverClassName: com.mysql.cj.jdbc.Driver</span>
<span class="line">        url: jdbc:mysql://jeecg-boot-mysql:3306/jeecg-boot?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Seoul</span>
<span class="line">        username: root</span>
<span class="line">        password: root</span>
<span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span>
<span class="line">    props:</span>
<span class="line">      sql-show: true</span>
<span class="line">    rules:</span>
<span class="line">      sharding:</span>
<span class="line">        binding-tables: sys_log</span>
<span class="line">        key-generators:</span>
<span class="line">          snowflake:</span>
<span class="line">            type: SNOWFLAKE</span>
<span class="line">            props:</span>
<span class="line">              worker-id: 123</span>
<span class="line">        sharding-algorithms:</span>
<span class="line">          table-classbased:</span>
<span class="line">            props:</span>
<span class="line">              strategy: standard</span>
<span class="line">              algorithmClassName: org.jeecg.modules.test.sharding.algorithm.StandardModTableShardAlgorithm</span>
<span class="line">            type: CLASS_BASED</span>
<span class="line">        tables:</span>
<span class="line">          sys_log:</span>
<span class="line">            actual-data-nodes: ds0.sys_log$-&gt;{0..1}</span>
<span class="line">            table-strategy:</span>
<span class="line">              standard:</span>
<span class="line">                sharding-algorithm-name: table-classbased</span>
<span class="line">                sharding-column: log_type</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>copy</p><p>2. After successful startup, enter <a href="http://localhost:8080%E6%89%93%E5%BC%80%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E5%A6%82%E4%B8%8B%E5%9B%BE" target="_blank" rel="noopener noreferrer">http://localhost:8080 in the browser to open the interface document as shown below</a><br><img src="https://lfs.k.topthink.com/lfs/aefc25871c8e19403791fde071cbf418590eb5151b424f1e1dbc5b4629d35213.dat" alt=""></p><p>The following code inserts 10 data in batches. According to the allocation rule, data with non-odd logType will be inserted into the sys_log1 table, and data with non-even logType will be inserted into the sys_log0 table.<br><img src="https://lfs.k.topthink.com/lfs/8eaa972d15e82587437cfa5fd71db0c8dafc47a572ce4a12beaf188891bebe2c.dat" alt=""></p><p>The test results are as follows<br><img src="https://lfs.k.topthink.com/lfs/108eadaf460646e56868682c9f22146f7cbae55b182a62a89a34bd81da5a9721.dat" alt=""><br><img src="https://lfs.k.topthink.com/lfs/1048d79fe7eba85d4cac60c9fd4ba4afcc983e5afe90bef389c949b89feb7f3c.dat" alt=""></p><h2 id="sub-library-and-sub-table-configuration" tabindex="-1"><a class="header-anchor" href="#sub-library-and-sub-table-configuration"><span><strong>Sub-library and sub-table configuration</strong></span></a></h2><ol><li>In <code>application-dev.yaml</code>the configuration file, add the following configuration</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">spring:</span>
<span class="line">  shardingsphere:</span>
<span class="line">    datasource:</span>
<span class="line">      names: ds0,ds1</span>
<span class="line">      ds0:</span>
<span class="line">        driverClassName: com.mysql.cj.jdbc.Driver</span>
<span class="line">        url: jdbc:mysql://jeecg-boot-mysql:3306/jeecg-boot?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Seoul</span>
<span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span>
<span class="line">        username: root</span>
<span class="line">        password: root</span>
<span class="line">      ds1:</span>
<span class="line">        driverClassName: com.mysql.cj.jdbc.Driver</span>
<span class="line">        url: jdbc:mysql://jeecg-boot-mysql:3306/jeecg-boot2?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Seoul</span>
<span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span>
<span class="line">        username: root</span>
<span class="line">        password: root</span>
<span class="line">    props:</span>
<span class="line">      sql-show: true</span>
<span class="line">    rules:</span>
<span class="line">      replica-query:</span>
<span class="line">        load-balancers:</span>
<span class="line">          round-robin:</span>
<span class="line">            type: ROUND_ROBIN</span>
<span class="line">            props:</span>
<span class="line">              default: 0</span>
<span class="line">        data-sources:</span>
<span class="line">          prds:</span>
<span class="line">            primary-data-source-name: ds0</span>
<span class="line">            replica-data-source-names: ds1</span>
<span class="line">            load-balancer-name: round_robin</span>
<span class="line">      sharding:</span>
<span class="line">        binding-tables:</span>
<span class="line">          - sys_log</span>
<span class="line">        key-generators:</span>
<span class="line">          snowflake:</span>
<span class="line">            type: SNOWFLAKE</span>
<span class="line">            props:</span>
<span class="line">              worker-id: 123</span>
<span class="line">        sharding-algorithms:</span>
<span class="line">          table-classbased:</span>
<span class="line">            props:</span>
<span class="line">              strategy: standard</span>
<span class="line">              algorithmClassName: org.jeecg.sharding.algorithm.StandardModTableShardAlgorithm</span>
<span class="line">            type: CLASS_BASED</span>
<span class="line">          database-inline:</span>
<span class="line">            type: INLINE</span>
<span class="line">            props:</span>
<span class="line">              algorithm-expression: ds$-&gt;{operate_type % 2}</span>
<span class="line">        tables:</span>
<span class="line">          sys_log:</span>
<span class="line">            actual-data-nodes: ds$-&gt;{0..1}.sys_log$-&gt;{0..1}</span>
<span class="line">            database-strategy:</span>
<span class="line">              standard:</span>
<span class="line">                sharding-column: operate_type</span>
<span class="line">                sharding-algorithm-name: database-inline</span>
<span class="line">            table-strategy:</span>
<span class="line">              standard:</span>
<span class="line">                sharding-algorithm-name: table-classbased</span>
<span class="line">                sharding-column: log_type</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>copy</p><h2 id="start-jeecg-system-start-and-the-console-will-have-the-following-output-indicating-that-the-sub-library-and-sub-table-integration-is-successful" tabindex="-1"><a class="header-anchor" href="#start-jeecg-system-start-and-the-console-will-have-the-following-output-indicating-that-the-sub-library-and-sub-table-integration-is-successful"><span>Start jeecg-system-start, and the console will have the following output, indicating that the sub-library and sub-table integration is successful</span></a></h2><p><img src="https://lfs.k.topthink.com/lfs/3a44cf144a07e0340cf3f8047eeca4d8631e29290fbca9ef6b8b5e83466ce397.dat" alt=""></p><p>2. Test the insertion and query interface<br><img src="https://upload.jeecg.com/jeecg/help/jeecgback/images/screenshot_1659854609381.png" alt=""><br> Sample code:<br><img src="https://upload.jeecg.com/jeecg/help/jeecgback/images/screenshot_1659855142185.png" alt=""></p><p>3. The test results are as follows. You can see that the operation_type%2==0 has entered <code>jeecg-boot 库(ds0)</code>, and the operation_type%2==1 has entered.<code>jeecg-boot2库(ds1)</code><br><img src="https://lfs.k.topthink.com/lfs/16e4ffdcdf8cfa8ec0c9a5d2c162307ce9f0eb2c003cc791f6fd9bb4e2ad35be.dat" alt=""><br><img src="https://lfs.k.topthink.com/lfs/b00f97d4984aac1481b904cd5d7d4000f14f573111cc5ad5671aa57694d34e74.dat" alt=""></p>`,31)]))}const t=n(l,[["render",d]]),p=JSON.parse('{"path":"/syncboot/advanced-features/integrated-sub-library-and-sub-table.html","title":"Integrated sub-library and sub-table","lang":"ko-KR","frontmatter":{"order":10},"git":{"updatedTime":1749507909000,"contributors":[{"name":"poh","username":"poh","email":"poh@empasy.com","commits":1,"url":"https://github.com/poh"}],"changelog":[{"hash":"b750c3240053572cbcbb08ac1e9cd0bd9974af53","time":1749507909000,"email":"poh@empasy.com","author":"poh","message":"build to docs:build"}]},"filePathRelative":"syncboot/advanced-features/integrated-sub-library-and-sub-table.md"}');export{t as comp,p as data};
