import{_ as s,c as a,b as p,o as e}from"./app-CDZlcnet.js";const t={};function l(i,n){return e(),a("div",null,n[0]||(n[0]=[p(`<h1 id="qwen2-vl-파인튜닝-가이드-by-llm" tabindex="-1"><a class="header-anchor" href="#qwen2-vl-파인튜닝-가이드-by-llm"><span>Qwen2-VL 파인튜닝 가이드 by LLM</span></a></h1><h2 id="🎯-파인튜닝-전-준비사항" tabindex="-1"><a class="header-anchor" href="#🎯-파인튜닝-전-준비사항"><span>🎯 파인튜닝 전 준비사항</span></a></h2><h3 id="_1-환경-설정" tabindex="-1"><a class="header-anchor" href="#_1-환경-설정"><span>1. <strong>환경 설정</strong></span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment"># 필수 패키지 설치</span></span>
<span class="line">pip <span class="token function">install</span> transformers<span class="token operator">&gt;=</span><span class="token number">4.37</span>.0</span>
<span class="line">pip <span class="token function">install</span> accelerate</span>
<span class="line">pip <span class="token function">install</span> datasets</span>
<span class="line">pip <span class="token function">install</span> peft</span>
<span class="line">pip <span class="token function">install</span> torch<span class="token operator">&gt;=</span><span class="token number">2.0</span>.0</span>
<span class="line">pip <span class="token function">install</span> torchvision</span>
<span class="line">pip <span class="token function">install</span> pillow</span>
<span class="line">pip <span class="token function">install</span> einops</span>
<span class="line">pip <span class="token function">install</span> timm</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Qwen2-VL 전용 패키지</span></span>
<span class="line">pip <span class="token function">install</span> git+https://github.com/QwenLM/Qwen2-VL.git</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-하드웨어-요구사항" tabindex="-1"><a class="header-anchor" href="#_2-하드웨어-요구사항"><span>2. <strong>하드웨어 요구사항</strong></span></a></h3><ul><li><strong>GPU 메모리</strong>: <ul><li>Full Fine-tuning: 80GB+ (A100 80GB)</li><li>LoRA Fine-tuning: 24GB+ (RTX 4090)</li><li>QLoRA: 16GB+ (V100 16GB)</li></ul></li></ul><h2 id="📊-데이터셋-형식" tabindex="-1"><a class="header-anchor" href="#📊-데이터셋-형식"><span>📊 데이터셋 형식</span></a></h2><h3 id="_1-표준-데이터-형식" tabindex="-1"><a class="header-anchor" href="#_1-표준-데이터-형식"><span>1. <strong>표준 데이터 형식</strong></span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;conversations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;image&gt;\\n이 이미지에서 무엇이 보이나요?&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;이 이미지에는 빨간색 스포츠카가 도로 위에 주차되어 있습니다.&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;base64_encoded_image_or_image_path&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-다중-턴-대화-형식" tabindex="-1"><a class="header-anchor" href="#_2-다중-턴-대화-형식"><span>2. <strong>다중 턴 대화 형식</strong></span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;conversations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;image&gt;\\n이 사진의 배경은 어디인가요?&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;도시의 거리입니다.&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;차량의 색상은 무엇인가요?&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;빨간색입니다.&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;base64_encoded_image&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🔧-파인튜닝-방법" tabindex="-1"><a class="header-anchor" href="#🔧-파인튜닝-방법"><span>🔧 파인튜닝 방법</span></a></h2><h3 id="_1-full-fine-tuning" tabindex="-1"><a class="header-anchor" href="#_1-full-fine-tuning"><span>1. <strong>Full Fine-tuning</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># full_finetune.py</span></span>
<span class="line"><span class="token keyword">import</span> torch</span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    Qwen2VLForConditionalGeneration<span class="token punctuation">,</span></span>
<span class="line">    Qwen2VLProcessor<span class="token punctuation">,</span></span>
<span class="line">    TrainingArguments<span class="token punctuation">,</span></span>
<span class="line">    Trainer</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">from</span> datasets <span class="token keyword">import</span> Dataset</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 모델 로드</span></span>
<span class="line">model <span class="token operator">=</span> Qwen2VLForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span></span>
<span class="line">    device_map<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">processor <span class="token operator">=</span> Qwen2VLProcessor<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 데이터셋 준비</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">load_dataset</span><span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">        data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">process_example</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 이미지 처리</span></span>
<span class="line">        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>example<span class="token punctuation">[</span><span class="token string">&#39;image_path&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">&#39;RGB&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 대화 처리</span></span>
<span class="line">        conversations <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#39;conversations&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        text <span class="token operator">=</span> processor<span class="token punctuation">.</span>apply_chat_template<span class="token punctuation">(</span>conversations<span class="token punctuation">,</span> add_generation_prompt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;pixel_values&#39;</span><span class="token punctuation">:</span> processor<span class="token punctuation">.</span>image_processor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">&quot;pt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pixel_values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">:</span> processor<span class="token punctuation">.</span>tokenizer<span class="token punctuation">(</span>text<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">&quot;pt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_ids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;labels&#39;</span><span class="token punctuation">:</span> processor<span class="token punctuation">.</span>tokenizer<span class="token punctuation">(</span>text<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">&quot;pt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_ids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> Dataset<span class="token punctuation">.</span>from_list<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>process_example<span class="token punctuation">,</span> batched<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">train_dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">&quot;train_data.json&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Training Arguments</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    output_dir<span class="token operator">=</span><span class="token string">&quot;./qwen2-vl-finetuned&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    per_device_train_batch_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">    learning_rate<span class="token operator">=</span><span class="token number">2e-5</span><span class="token punctuation">,</span></span>
<span class="line">    num_train_epochs<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    logging_steps<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">    save_steps<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span></span>
<span class="line">    eval_steps<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span></span>
<span class="line">    warmup_steps<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">    weight_decay<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span></span>
<span class="line">    gradient_checkpointing<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    remove_unused_columns<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Trainer 설정</span></span>
<span class="line">trainer <span class="token operator">=</span> Trainer<span class="token punctuation">(</span></span>
<span class="line">    model<span class="token operator">=</span>model<span class="token punctuation">,</span></span>
<span class="line">    args<span class="token operator">=</span>training_args<span class="token punctuation">,</span></span>
<span class="line">    train_dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span></span>
<span class="line">    data_collator<span class="token operator">=</span><span class="token keyword">lambda</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&#39;pixel_values&#39;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">&#39;pixel_values&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>pad_sequence<span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">&#39;input_ids&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            padding_value<span class="token operator">=</span>processor<span class="token punctuation">.</span>tokenizer<span class="token punctuation">.</span>pad_token_id</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;labels&#39;</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>pad_sequence<span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">&#39;labels&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            padding_value<span class="token operator">=</span><span class="token operator">-</span><span class="token number">100</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 학습 시작</span></span>
<span class="line">trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">trainer<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-lora-파인튜닝" tabindex="-1"><a class="header-anchor" href="#_2-lora-파인튜닝"><span>2. <strong>LoRA 파인튜닝</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># lora_finetune.py</span></span>
<span class="line"><span class="token keyword">from</span> peft <span class="token keyword">import</span> LoraConfig<span class="token punctuation">,</span> get_peft_model</span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> Qwen2VLForConditionalGeneration</span>
<span class="line"></span>
<span class="line"><span class="token comment"># LoRA 설정</span></span>
<span class="line">lora_config <span class="token operator">=</span> LoraConfig<span class="token punctuation">(</span></span>
<span class="line">    r<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></span>
<span class="line">    lora_alpha<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span></span>
<span class="line">    target_modules<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;q_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;k_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;o_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gate_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;up_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;down_proj&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    lora_dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span></span>
<span class="line">    bias<span class="token operator">=</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    task_type<span class="token operator">=</span><span class="token string">&quot;CAUSAL_LM&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 모델에 LoRA 적용</span></span>
<span class="line">model <span class="token operator">=</span> Qwen2VLForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span></span>
<span class="line">    device_map<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> get_peft_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span> lora_config<span class="token punctuation">)</span></span>
<span class="line">model<span class="token punctuation">.</span>print_trainable_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 학습률을 더 높게 설정</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    output_dir<span class="token operator">=</span><span class="token string">&quot;./qwen2-vl-lora&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    per_device_train_batch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>  <span class="token comment"># LoRA는 메모리 사용량이 적음</span></span>
<span class="line">    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    learning_rate<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">,</span>  <span class="token comment"># 더 높은 학습률</span></span>
<span class="line">    num_train_epochs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment"># ... 나머지 설정은 동일</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-qlora-파인튜닝-4bit-양자화" tabindex="-1"><a class="header-anchor" href="#_3-qlora-파인튜닝-4bit-양자화"><span>3. <strong>QLoRA 파인튜닝 (4bit 양자화)</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># qlora_finetune.py</span></span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> BitsAndBytesConfig</span>
<span class="line"><span class="token keyword">from</span> peft <span class="token keyword">import</span> prepare_model_for_kbit_training</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4bit 양자화 설정</span></span>
<span class="line">quantization_config <span class="token operator">=</span> BitsAndBytesConfig<span class="token punctuation">(</span></span>
<span class="line">    load_in_4bit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    bnb_4bit_use_double_quant<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">    bnb_4bit_quant_type<span class="token operator">=</span><span class="token string">&quot;nf4&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    bnb_4bit_compute_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 양자화된 모델 로드</span></span>
<span class="line">model <span class="token operator">=</span> Qwen2VLForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    quantization_config<span class="token operator">=</span>quantization_config<span class="token punctuation">,</span></span>
<span class="line">    device_map<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># QLoRA 준비</span></span>
<span class="line">model <span class="token operator">=</span> prepare_model_for_kbit_training<span class="token punctuation">(</span>model<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># LoRA 설정 (QLoRA)</span></span>
<span class="line">lora_config <span class="token operator">=</span> LoraConfig<span class="token punctuation">(</span></span>
<span class="line">    r<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>  <span class="token comment"># 더 작은 rank</span></span>
<span class="line">    lora_alpha<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></span>
<span class="line">    target_modules<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;q_proj&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v_proj&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 주요 모듈만 대상</span></span>
<span class="line">    lora_dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span></span>
<span class="line">    bias<span class="token operator">=</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    task_type<span class="token operator">=</span><span class="token string">&quot;CAUSAL_LM&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> get_peft_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span> lora_config<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="📝-데이터-전처리-유틸리티" tabindex="-1"><a class="header-anchor" href="#📝-데이터-전처리-유틸리티"><span>📝 데이터 전처리 유틸리티</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># data_utils.py</span></span>
<span class="line"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image</span>
<span class="line"><span class="token keyword">import</span> base64</span>
<span class="line"><span class="token keyword">import</span> io</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">image_to_base64</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;이미지를 base64로 변환&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> image_file<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>image_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">base64_to_image</span><span class="token punctuation">(</span>base64_str<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;base64를 이미지로 변환&quot;&quot;&quot;</span></span>
<span class="line">    image_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>base64_str<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">create_conversation_dataset</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> questions<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;데이터셋 생성 도우미&quot;&quot;&quot;</span></span>
<span class="line">    dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">for</span> img_path<span class="token punctuation">,</span> question<span class="token punctuation">,</span> answer <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> questions<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;conversations&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;&lt;image&gt;\\n</span><span class="token interpolation"><span class="token punctuation">{</span>question<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> answer</span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;image&quot;</span><span class="token punctuation">:</span> image_to_base64<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> dataset</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">save_dataset</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> output_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;데이터셋 저장&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> <span class="token string">&#39;w&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🚀-학습-스크립트-예제" tabindex="-1"><a class="header-anchor" href="#🚀-학습-스크립트-예제"><span>🚀 학습 스크립트 예제</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># train_qwen2_vl.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 환경 변수 설정</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">MODEL_NAME</span><span class="token operator">=</span><span class="token string">&quot;Qwen/Qwen2-VL-7B-Instruct&quot;</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">DATA_PATH</span><span class="token operator">=</span><span class="token string">&quot;train_data.json&quot;</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">OUTPUT_DIR</span><span class="token operator">=</span><span class="token string">&quot;./qwen2-vl-finetuned&quot;</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">BATCH_SIZE</span><span class="token operator">=</span><span class="token number">2</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">LEARNING_RATE</span><span class="token operator">=</span>2e-5</span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">EPOCHS</span><span class="token operator">=</span><span class="token number">3</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 학습 실행</span></span>
<span class="line">python <span class="token parameter variable">-m</span> torch.distributed.launch <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--nproc_per_node</span><span class="token operator">=</span><span class="token number">4</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--master_port</span><span class="token operator">=</span><span class="token number">29500</span> <span class="token punctuation">\\</span></span>
<span class="line">    train_qwen2_vl.py <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--model_name</span> <span class="token variable">$MODEL_NAME</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--data_path</span> <span class="token variable">$DATA_PATH</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--output_dir</span> <span class="token variable">$OUTPUT_DIR</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--per_device_train_batch_size</span> <span class="token variable">$BATCH_SIZE</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--learning_rate</span> <span class="token variable">$LEARNING_RATE</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--num_train_epochs</span> <span class="token variable">$EPOCHS</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--fp16</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--gradient_checkpointing</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--logging_steps</span> <span class="token number">10</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--save_steps</span> <span class="token number">500</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🔍-평가-및-추론" tabindex="-1"><a class="header-anchor" href="#🔍-평가-및-추론"><span>🔍 평가 및 추론</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># evaluate.py</span></span>
<span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> pipeline</span>
<span class="line"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 파인튜닝된 모델 로드</span></span>
<span class="line">model_path <span class="token operator">=</span> <span class="token string">&quot;./qwen2-vl-finetuned&quot;</span></span>
<span class="line">vl_pipeline <span class="token operator">=</span> pipeline<span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;visual-question-answering&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    model<span class="token operator">=</span>model_path<span class="token punctuation">,</span></span>
<span class="line">    device<span class="token operator">=</span><span class="token string">&quot;cuda:0&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 테스트 이미지</span></span>
<span class="line">image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;test_image.jpg&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 추론</span></span>
<span class="line">question <span class="token operator">=</span> <span class="token string">&quot;이 이미지에서 무엇이 보이나요?&quot;</span></span>
<span class="line">result <span class="token operator">=</span> vl_pipeline<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">,</span> question<span class="token operator">=</span>question<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Question: </span><span class="token interpolation"><span class="token punctuation">{</span>question<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Answer: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">&#39;answer&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Confidence: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">&#39;score&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="⚡-최적화-팁" tabindex="-1"><a class="header-anchor" href="#⚡-최적화-팁"><span>⚡ 최적화 팁</span></a></h2><h3 id="_1-메모리-최적화" tabindex="-1"><a class="header-anchor" href="#_1-메모리-최적화"><span>1. <strong>메모리 최적화</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 그래디언트 체크포인팅</span></span>
<span class="line">model<span class="token punctuation">.</span>gradient_checkpointing_enable<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 배치 사이즈 조정</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    per_device_train_batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>  <span class="token comment"># 효과적 배치 크기: 8</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># mixed precision training</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 또는 bf16=True</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-학습률-스케줄링" tabindex="-1"><a class="header-anchor" href="#_2-학습률-스케줄링"><span>2. <strong>학습률 스케줄링</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> get_cosine_schedule_with_warmup</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 웜업 스케줄러</span></span>
<span class="line">num_training_steps <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_dataloader<span class="token punctuation">)</span> <span class="token operator">*</span> num_epochs</span>
<span class="line">num_warmup_steps <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">*</span> num_training_steps<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">scheduler <span class="token operator">=</span> get_cosine_schedule_with_warmup<span class="token punctuation">(</span></span>
<span class="line">    optimizer<span class="token punctuation">,</span></span>
<span class="line">    num_warmup_steps<span class="token operator">=</span>num_warmup_steps<span class="token punctuation">,</span></span>
<span class="line">    num_training_steps<span class="token operator">=</span>num_training_steps</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🎯-특정-태스크-파인튜닝-예제" tabindex="-1"><a class="header-anchor" href="#🎯-특정-태스크-파인튜닝-예제"><span>🎯 특정 태스크 파인튜닝 예제</span></a></h2><h3 id="_1-이미지-캡셔닝" tabindex="-1"><a class="header-anchor" href="#_1-이미지-캡셔닝"><span>1. <strong>이미지 캡셔닝</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">prepare_captioning_data</span><span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> captions_file<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;이미지 캡셔닝 데이터 준비&quot;&quot;&quot;</span></span>
<span class="line">    dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>captions_file<span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span></span>
<span class="line">            img_name<span class="token punctuation">,</span> caption <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;\\t&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;conversations&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                    <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;human&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;&lt;image&gt;\\n이 이미지를 설명해주세요.&quot;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gpt&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> caption</span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;image&quot;</span><span class="token punctuation">:</span> image_to_base64<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>image_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>img_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> dataset</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-vqa-visual-question-answering" tabindex="-1"><a class="header-anchor" href="#_2-vqa-visual-question-answering"><span>2. <strong>VQA (Visual Question Answering)</strong></span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">prepare_vqa_data</span><span class="token punctuation">(</span>questions_file<span class="token punctuation">,</span> annotations_file<span class="token punctuation">,</span> image_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;VQA 데이터 준비&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token comment"># questions 및 annotations 파일 처리</span></span>
<span class="line">    <span class="token comment"># ...</span></span>
<span class="line">    <span class="token keyword">return</span> vqa_dataset</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="📊-모니터링-및-로깅" tabindex="-1"><a class="header-anchor" href="#📊-모니터링-및-로깅"><span>📊 모니터링 및 로깅</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># wandb 연동</span></span>
<span class="line"><span class="token keyword">import</span> wandb</span>
<span class="line"></span>
<span class="line">wandb<span class="token punctuation">.</span>init<span class="token punctuation">(</span>project<span class="token operator">=</span><span class="token string">&quot;qwen2-vl-finetuning&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    output_dir<span class="token operator">=</span><span class="token string">&quot;./output&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    report_to<span class="token operator">=</span><span class="token string">&quot;wandb&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># wandb에 리포트</span></span>
<span class="line">    logging_dir<span class="token operator">=</span><span class="token string">&quot;./logs&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    logging_steps<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🛠️-문제-해결" tabindex="-1"><a class="header-anchor" href="#🛠️-문제-해결"><span>🛠️ 문제 해결</span></a></h2><h3 id="common-issues" tabindex="-1"><a class="header-anchor" href="#common-issues"><span><strong>Common Issues:</strong></span></a></h3><ol><li><strong>CUDA Out of Memory</strong>: 배치 사이즈 줄이기, 그래디언트 accumulation 사용</li><li><strong>NaN Loss</strong>: 학습률 낮추기, gradient clipping 적용</li><li><strong>Slow Training</strong>: mixed precision 사용, 데이터 로딩 최적화</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 그래디언트 클리핑</span></span>
<span class="line">training_args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span></span>
<span class="line">    max_grad_norm<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token comment"># 그래디언트 클리핑</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,40)]))}const c=s(t,[["render",l]]),u=JSON.parse('{"path":"/study/qwen2vlfinetuning.html","title":"Qwen2 VL Fine-Tuning","lang":"ko-KR","frontmatter":{"title":"Qwen2 VL Fine-Tuning","description":"Qwen2 VL 모델 FIne-Tuning","head":[["meta",{"name":"keywords","content":"공부기록, 학습일기, 지식저장소, 공부로그, 학습관리, 공부노트, 지식정리, 공부방법, 학습저장, 기억보조"}],["meta",{"property":"og:title","content":"📚 두뇌 저장소 - 재미있는 공부 기록 놀이터"}],["meta",{"property":"og:description","content":"까먹지 말고 재밌게 저장하자! 🎯 공부한 내용을 자유롭게 기록하는 즐거운 지식 저장소"}],["meta",{"property":"og:image","content":"https://doc.empasy.com/images/favicon.png"}],["meta",{"property":"og:url","content":"https://doc.empasy.com/study/"}]],"sort":400},"git":{"updatedTime":1756461948000,"contributors":[{"name":"poh","username":"poh","email":"poh@empasy.com","commits":1,"url":"https://github.com/poh"}],"changelog":[{"hash":"88e4a493a2164eaddef219387a4b13a0a02cc20a","time":1756461948000,"email":"poh@empasy.com","author":"poh","message":"데일리 스크럽 예시 스크립트 변경"}]},"filePathRelative":"study/qwen2vlfinetuning.md"}');export{c as comp,u as data};
